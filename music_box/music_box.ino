#include <Wire.h>
#include "AMS_5600.h"
#include "wavTrigger.h"

#define NOTE_COUNT 262
#define ENCODER_RESOLUTION 4096

uint16_t notes[NOTE_COUNT][2] = {{20,60},{30,64},{36,67},{51,72},{480,60},{480,64},{795,71},{960,55},{975,69},{1280,67},{1440,55},{1440,64},{1740,72},{1920,60},{1940,71},{1986,72},{2040,71},{2400,60},{2400,64},{2700,69},{2880,55},{2896,67},{3194,64},{3360,55},{3360,60},{3660,71},{3840,60},{3852,69},{4320,60},{4320,64},{4640,67},{4800,55},{4811,64},{5120,59},{5280,55},{5280,60},{5587,71},{5760,62},{5774,69},{6240,62},{6380,64},{6506,65},{6600,69},{6720,55},{6733,67},{7200,55},{7680,57},{7693,65},{7707,74},{8160,65},{8160,69},{8400,72},{8640,57},{8650,71},{8760,69},{8900,65},{9120,65},{9120,69},{9130,72},{9454,71},{9540,72},{9600,62},{9600,71},{10080,65},{10080,69},{10215,69},{10340,71},{10440,69},{10560,55},{10560,67},{10760,65},{11040,62},{11051,65},{11115,71},{11520,57},{11533,69},{12000,62},{12000,65},{12480,55},{12480,67},{12558,66},{12639,65},{12720,64},{12798,63},{12960,62},{12980,65},{12995,71},{13440,60},{13460,69},{14040,72},{14100,71},{14173,70},{14251,69},{14319,68},{14400,55},{14400,67},{14880,55},{15360,60},{15380,64},{15392,67},{15420,72},{15840,60},{15840,64},{16040,71},{16140,72},{16238,71},{16320,55},{16320,69},{16431,67},{16524,64},{16800,55},{16810,72},{17280,60},{17280,71},{17760,60},{17760,64},{18107,69},{18240,55},{18244,67},{18388,64},{18534,60},{18720,55},{18745,71},{19200,60},{19212,69},{19680,60},{19680,64},{20020,67},{20160,55},{20160,64},{20520,59},{20640,55},{20640,60},{21015,72},{21120,53},{21135,57},{21147,72},{21152,65},{21600,57},{21610,60},{21620,65},{22080,57},{22094,60},{22104,65},{22111,69},{22440,69},{22560,60},{22560,65},{22665,71},{22785,72},{22898,73},{23040,53},{23040,74},{23165,74},{23520,56},{23527,60},{23534,68},{23883,72},{23999,74},{24000,53},{24134,74},{24480,56},{24489,60},{24489,68},{24809,72},{24960,52},{24960,74},{25160,74},{25352,74},{25440,55},{25449,60},{25453,67},{25504,72},{25634,67},{25920,52},{26400,55},{26409,60},{26416,67},{26693,72},{26880,51},{26880,74},{27057,74},{27257,74},{27360,54},{27367,57},{27371,60},{27373,62},{27377,66},{27680,72},{27840,51},{27840,74},{27980,74},{28320,54},{28332,57},{28340,62},{28346,66},{28640,72},{28800,53},{28800,74},{29040,74},{29263,74},{29380,72},{29500,69},{29624,72},{29760,55},{29786,65},{29820,71},{29848,76},{30420,57},{30569,55},{30720,60},{30735,72},{30960,60},{30960,64},{31200,64},{31200,67},{31420,67},{31420,71},{31660,72},{31680,55},{31734,71},{31806,70},{31868,69},{31940,68},{32005,67},{32074,66},{32140,65},{32160,55},{32220,64},{32480,72},{32640,60},{32640,71},{32880,60},{32880,64},{33120,64},{33120,67},{33280,69},{33392,67},{33400,71},{33480,69},{33600,55},{33612,67},{33760,64},{33903,60},{34080,55},{34080,64},{34240,67},{34377,71},{34560,53},{34577,57},{34591,62},{34600,65},{34615,69},{35040,69},{35214,71},{35371,72},{35520,55},{35551,65},{35570,67},{35587,71},{35596,76},{36480,72}};

AMS_5600 ams5600;
wavTrigger wTrig;

unsigned long last_interaction;

uint16_t position;
uint16_t last_position;
int16_t delta;

double ticks;
unsigned long end_of_track;
uint16_t latest_note_index;

uint16_t note_ticks;
uint16_t note_number;


void setup() {
  Serial.begin(115200);
  Wire.begin();

  wTrig.start();

  wTrig.setAmpPwr(true);
  wTrig.masterGain(-10);

  last_interaction = millis();

  end_of_track = notes[NOTE_COUNT-1][0];
  reset();
}

void reset() {
  position = 0;
  last_position = 0;

  ticks = 0;
  latest_note_index = 0;
}

void loop() {
  if (millis() - last_interaction > 1000 * 8) {
    reset();
  }

  if (ams5600.detectMagnet() == 0) return;

  position = ams5600.getRawAngle();
  delta = position - last_position;

  if (delta > 2048) delta -= 4096;
  if (delta < -2048) delta += 4096;

  if (abs(delta) > 100) return;
  if (abs(delta) < 5) return;

  last_interaction = millis();
  last_position = position;

  ticks += float(delta) * (960.0f / 2048.0f);
  // Serial.println(ticks);

  if (ticks > end_of_track) {
    return reset();
  }

  playNextNotes();
  delay(10);
}

void playNextNotes() {
  for (
    note_ticks = notes[latest_note_index][0],
    note_number = notes[latest_note_index][1];
    note_ticks < ticks;
    note_ticks = notes[latest_note_index][0],
    note_number = notes[latest_note_index][1]
  ) {
    wTrig.trackPlayPoly(note_number);
    latest_note_index++;
  }
}
